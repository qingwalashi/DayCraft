# 工作分解功能更新

## 功能概述

在工作分解页面中新增了两个重要功能：
1. **拖拽排序功能**: 在编辑模式下支持同一层级下的工作项拖拽排序
2. **里程碑标识功能**: 支持将工作项标记为里程碑，并在各种视图中显示特殊标识

## 功能特性

## 一、拖拽排序功能

### 1. 拖拽手柄
- 在编辑模式下，每个工作项左侧会显示一个拖拽手柄图标（⋮⋮）
- 鼠标悬停时会显示"拖拽排序"提示
- 点击并拖拽该手柄可以移动工作项

### 2. 同级排序限制
- 只能在同一层级内进行拖拽排序
- 不能跨层级拖拽（例如：不能将2级工作项拖拽到1级）
- 如果尝试跨层级拖拽，会显示错误提示

### 3. 实时保存
- 拖拽完成后，新的排序会立即保存到数据库
- 保存成功会显示"排序已保存"提示
- 如果保存失败，会恢复到原始排序并显示错误提示

### 4. 视觉反馈
- 拖拽过程中，被拖拽的项目会变为半透明
- 拖拽手柄支持鼠标悬停效果
- 拖拽时鼠标指针会变为抓取状态

## 二、里程碑标识功能

### 1. 里程碑复选框
- 在编辑模式下，工作项名称输入框右侧显示里程碑复选框
- 可以勾选或取消勾选来设置工作项是否为里程碑
- 复选框状态会实时影响里程碑标识的显示

### 2. 里程碑标识显示
- **编辑模式**: 只显示里程碑复选框，不显示标识
- **查看模式**: 在工作项名称后显示"🏁 里程碑"黄色标识
- **保存后生效**: 只有保存后的工作项才会显示里程碑标识

### 3. 视觉设计
- 使用黄色背景和边框突出显示里程碑
- 统一的视觉风格在所有视图中保持一致
- 旗帜图标(🏁)增强视觉识别度

## 使用方法

## 拖拽排序使用方法

### 步骤1：进入编辑模式
1. 在工作分解页面，点击右上角的"编辑"按钮
2. 页面会切换到编辑模式，显示所有操作按钮

### 步骤2：拖拽排序
1. 找到要移动的工作项
2. 将鼠标悬停在工作项左侧的拖拽手柄（⋮⋮）上
3. 按住鼠标左键并拖拽到目标位置
4. 释放鼠标完成排序

### 步骤3：确认保存
- 拖拽完成后系统会自动保存
- 查看页面右上角的提示信息确认保存状态

## 里程碑标识使用方法

### 步骤1：进入编辑模式
1. 在工作分解页面，点击右上角的"编辑"按钮
2. 页面会切换到编辑模式，显示所有操作按钮

### 步骤2：设置里程碑
1. 创建新工作项或编辑现有工作项
2. 在工作项名称输入框右侧找到"里程碑"复选框
3. 勾选复选框将工作项标记为里程碑
4. 编辑状态下不会显示里程碑标识

### 步骤3：保存设置
1. 点击"保存"按钮保存工作项
2. 保存后，里程碑工作项会在查看模式中显示"🏁 里程碑"标识
3. 在所有视图模式中都能看到里程碑标识

## 技术实现

### 使用的库
- `@dnd-kit/core`: 核心拖拽功能
- `@dnd-kit/sortable`: 排序功能
- `@dnd-kit/utilities`: 工具函数

### 关键组件
- `SortableWorkItem`: 可拖拽的工作项组件
- `DndContext`: 拖拽上下文提供者
- `SortableContext`: 排序上下文提供者

### 数据库更新
- 使用批量更新API `updateWorkItemPositions`
- 更新每个工作项的`position`字段
- 自动清除相关缓存

## 注意事项

1. **仅在编辑模式下可用**: 预览模式和思维导图模式下不支持拖拽
2. **同级限制**: 只能在相同父级下的工作项之间拖拽
3. **网络依赖**: 需要网络连接来保存排序结果
4. **权限要求**: 需要对项目有编辑权限

## 故障排除

### 拖拽不生效
- 确认当前处于编辑模式
- 检查是否有网络连接
- 刷新页面重试

### 排序未保存
- 检查网络连接
- 查看浏览器控制台是否有错误信息
- 确认对项目有编辑权限

### 跨层级拖拽失败
- 这是预期行为，只能在同一层级内排序
- 如需调整层级结构，请使用编辑功能

## 未来改进

1. 支持跨层级拖拽（需要更复杂的逻辑处理）
2. 添加拖拽预览效果
3. 支持键盘快捷键排序
4. 批量选择和排序功能
