# 项目周报功能使用说明

## 功能概述

项目周报功能允许用户按周管理和记录项目工作内容，支持多项目、多级工作项选择，并可标记为工作计划。

## 主要特性

1. **按周管理**：以周为单位组织工作报告
2. **项目关联**：每个工作项必须关联到具体项目
3. **多级工作项**：支持选择项目下的多级工作分解结构
4. **工作计划标记**：可将周报标记为工作计划
5. **权限控制**：只有user角色用户可以访问，支持RLS权限控制
6. **智能分组显示**：按项目自动分组，相同项目的内容合并显示
7. **灵活展示控制**：支持切换显示工作项详情和多层级结构

## 数据库设置

### 1. 执行SQL建表语句

项目周报相关的SQL语句已经合并到 `sql/create_tables.sql` 主建表文件中。执行该文件将创建以下表：

- `project_weekly_reports` - 项目周报主表
- `project_weekly_report_items` - 项目周报条目表

如果您已经执行过主建表文件，则无需额外操作。如果是新安装，请执行完整的 `sql/create_tables.sql` 文件。

### 2. RLS权限说明

已自动设置以下RLS策略：
- 用户只能查看、创建、更新、删除自己的项目周报
- 管理员可以查看所有用户的项目周报
- 所有操作都需要用户身份验证

## 功能使用

### 1. 访问项目周报

- 在导航菜单中选择 "报告" > "项目周报"
- 或直接访问 `/dashboard/project-reports`

### 2. 查看周报列表

- 支持周导航：上一周/下一周/本周
- 显示当前周的项目周报内容
- 如果本周未填写，会显示提醒
- **按项目分组显示**：相同项目的工作内容自动合并
- **展示控制开关**：
  - 工作项开关：显示/隐藏具体工作项分类
  - 层级开关：显示/隐藏工作项的多层级结构

### 3. 创建/编辑项目周报

#### 基本信息
- 自动显示当前周的时间范围
- 可选择标记为"工作计划"

#### 添加工作项
1. 点击"添加工作项"按钮
2. 选择项目（必填）
3. 选择工作项（可选，支持多级选择）
4. 填写工作内容（必填）

#### 多级工作项选择
- 首先选择项目
- 系统自动加载该项目的工作分解结构
- 支持最多5级工作项选择
- 工作项以缩进形式显示层级关系

### 4. 保存和管理

- 点击"保存周报"保存内容
- 支持编辑已有周报
- 支持删除整个周报

## 页面结构

### 项目周报列表页 (`/dashboard/project-reports`)
- 周导航控件
- 当前周报告内容展示
- 新建/编辑/删除操作
- **智能分组显示**：
  - 按项目自动分组，每个项目可展开/折叠
  - 显示项目下的工作数量统计
  - 区分直接项目工作和工作项分类工作
- **显示控制开关**：
  - 工作项开关：控制是否显示工作项分类
  - 层级开关：控制是否显示工作项层级信息

### 项目周报编辑页 (`/dashboard/project-reports/new`)
- 周信息显示
- 工作计划标记选项
- 动态工作项添加/删除
- 项目和工作项级联选择
- 保存/取消操作

## 技术实现

### 前端组件
- 使用React Hook进行状态管理
- 支持响应式设计（移动端适配）
- 集成date-fns进行日期处理
- 使用Tailwind CSS进行样式设计
- **智能缓存机制**：参照日报页面逻辑，避免tab切换和浏览器最小化后不必要的重新加载

### 数据处理
- 使用ISO周标准进行周数计算
- 支持工作分解结构的树形数据处理
- 实现级联选择逻辑
- **持久化状态管理**：使用 `usePersistentState` 保持页面状态
- **智能数据加载**：避免重复请求，只在必要时刷新数据
- **智能数据分组**：自动按项目和工作项进行数据分组和聚合
- **层级信息处理**：获取和显示工作项的完整层级结构

### 权限控制
- 集成Supabase RLS策略
- 用户身份验证检查
- 数据访问权限控制

## 显示功能详解

### 项目分组显示
- **自动分组**：系统自动将工作内容按项目进行分组
- **折叠展开**：每个项目组可以独立折叠或展开
- **统计信息**：显示每个项目下的工作项数量
- **颜色区分**：不同类型的工作使用不同的背景色区分

### 工作项显示控制
1. **工作项开关**：
   - 开启：按工作项分类显示，清晰展示工作结构
   - 关闭：简化显示，所有内容平铺展示

2. **层级开关**（仅在工作项开关开启时可用）：
   - 开启：展开显示完整的工作项层级结构（一级工作项 > 二级工作项 > 三级工作项）
   - 关闭：简化显示，只显示工作项名称

### 视觉设计
- **项目组**：灰色边框，蓝色标题，可折叠
- **直接工作**：蓝色背景，表示直接在项目下的工作
- **工作项分类**：绿色左边框，绿色背景，层次清晰
- **层级结构**：递进缩进，完整路径显示，层级标识（L0、L1、L2等）
- **响应式设计**：适配桌面和移动设备

### 层级展开功能详解

当开启"层级"开关时，系统会：

1. **构建完整层级结构**：
   - 自动获取项目的所有工作分解项
   - 构建父子关系的树形结构
   - 计算每个工作项的完整路径

2. **展示层级路径**：
   ```
   简单模式：
   - 需求分析 (2项)
   - 系统设计 (1项)
   - 编码实现 (1项)
   - 其他工作 (1项)

   层级模式：
   - L0 项目开发 > 需求分析 (2项)
   - L1 项目开发 > 系统设计 > 架构设计 (1项)
   - L2 项目开发 > 系统设计 > 数据库设计 (1项)
   - L1 项目开发 > 编码实现 > 前端开发 (1项)
   - 其他工作 (1项)
   ```

3. **智能内容分类**：
   - 有工作项的内容：按工作项分类显示
   - 未选择工作项的内容：统一归类到"其他工作"
   - 空工作项：自动过滤，不显示

4. **简化层级显示**：
   - 层级模式：直接显示完整路径（一级 > 二级 > 三级）
   - 不使用递进缩进，避免复杂的嵌套结构
   - 平铺展示，便于阅读和理解

5. **智能数据处理**：
   - 只显示有实际工作内容的工作项
   - 自动过滤空的工作项分支
   - 保持数据的完整性和准确性

## 内容分类规则

### 工作项分类
- **有工作项的内容**：显示在对应的工作项分类下
- **未选择工作项的内容**：统一显示在"其他工作"分类中
- **空工作项**：不显示，保持界面简洁

### 显示顺序
1. **工作项内容**：按层级和字母顺序排列
2. **其他工作**：始终显示在最后，使用灰色边框区分

### 视觉区分
- **工作项内容**：绿色左边框，绿色背景
- **其他工作**：灰色左边框，灰色背景
- **层级标识**：L0、L1、L2等清晰标记

## 注意事项

1. **数据库依赖**：需要先创建projects和work_breakdown_items表
2. **用户权限**：只有user角色用户可以访问此功能
3. **周数计算**：使用ISO 8601周标准，一年最多53周
4. **工作项选择**：工作项为可选，可以直接在项目下添加工作内容
5. **数据验证**：保存时会验证必填字段和数据完整性
6. **缓存机制**：页面数据会被缓存，切换tab或最小化浏览器后不会重新加载，提升用户体验

## 扩展功能

未来可以考虑添加：
- 周报模板功能
- 批量导入/导出
- 周报统计分析
- 团队周报汇总
- 邮件通知提醒

## 快速开始

现在您可以：
1. **新安装**：执行完整的 `sql/create_tables.sql` 文件到Supabase中建表
2. **已有数据库**：项目周报相关的SQL语句已包含在主建表文件中，无需额外操作
3. **测试功能**：重启开发服务器，在报告菜单中访问"项目周报"功能
4. **开始使用**：创建您的第一个项目周报！
